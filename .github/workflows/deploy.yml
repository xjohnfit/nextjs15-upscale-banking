name: Build and Deploy Upscale Banking

on:
  push:
    branches:
      - main

env:
  IMAGE_NAME:  xjohnfit/upscale-banking
  DEPLOYMENT_NAME: upscale-banking
  
jobs:
  CI:
    name: Build
    runs-on: [self-hosted]
    steps:
      
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      
      - name: Sonarqube Analysis
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        continue-on-error: true
      
      - name: Trivy File Scan
        run: trivy fs . > trivyfs. txt
        continue-on-error: true
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context:  .
          tags: ${{ steps.meta.outputs.tags }}
          annotations: ${{ steps.meta.outputs.annotations }}
          push: true
          cache-from: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.IMAGE_NAME }}: buildcache,mode=max

      - name: Trivy Image Scan
        run: trivy image ${{ env.IMAGE_NAME }} > trivyimage.txt
        continue-on-error: true

      # Upload scan results (fixed to v4)
      - name: Upload Trivy Scan Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-scan-results
          path: |
            trivyfs.txt
            trivyimage.txt
          retention-days: 30

      - name: Slack Notification
        if: always()
        uses: act10ns/slack@v1
        with:
          status: ${{ job.status }}
          steps: ${{ toJson(steps) }}
          channel: '#all-apps'
        env: 
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

  CD:
    name: Deploy
    needs: CI
    runs-on: [self-hosted]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up kubeconfig for k3s
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_K3S" > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          export KUBECONFIG=$HOME/.kube/config
        env:
          KUBECONFIG_K3S: ${{ secrets.KUBECONFIG_K3S }}

      - name: Create Docker registry secret
        run: |
          kubectl delete secret regcred --ignore-not-found
          kubectl create secret docker-registry regcred \
            --docker-server=https://index.docker.io/v1/ \
            --docker-username=${{ secrets. DOCKERHUB_USERNAME }} \
            --docker-password=${{ secrets.DOCKERHUB_TOKEN }}

      - name: Create application secrets
        run: |
          kubectl delete secret upscale-banking-secrets --ignore-not-found
          kubectl create secret generic upscale-banking-secrets \
            --from-literal=NEXT_PUBLIC_SITE_URL="${{ secrets.NEXT_PUBLIC_SITE_URL }}" \
            --from-literal=NEXT_PUBLIC_APPWRITE_ENDPOINT="${{ secrets.NEXT_PUBLIC_APPWRITE_ENDPOINT }}" \
            --from-literal=NEXT_PUBLIC_APPWRITE_PROJECT="${{ secrets.NEXT_PUBLIC_APPWRITE_PROJECT }}" \
            --from-literal=APPWRITE_DATABASE_ID="${{ secrets.APPWRITE_DATABASE_ID }}" \
            --from-literal=APPWRITE_USER_COLLECTION_ID="${{ secrets.APPWRITE_USER_COLLECTION_ID }}" \
            --from-literal=APPWRITE_BANK_COLLECTION_ID="${{ secrets.APPWRITE_BANK_COLLECTION_ID }}" \
            --from-literal=APPWRITE_TRANSACTION_COLLECTION_ID="${{ secrets.APPWRITE_TRANSACTION_COLLECTION_ID }}" \
            --from-literal=NEXT_APPWRITE_KEY="${{ secrets.NEXT_APPWRITE_KEY }}" \
            --from-literal=PLAID_CLIENT_ID="${{ secrets.PLAID_CLIENT_ID }}" \
            --from-literal=PLAID_SECRET="${{ secrets.PLAID_SECRET }}" \
            --from-literal=PLAID_ENV="${{ secrets.PLAID_ENV }}" \
            --from-literal=PLAID_PRODUCTS="${{ secrets.PLAID_PRODUCTS }}" \
            --from-literal=PLAID_COUNTRY_CODES="${{ secrets.PLAID_COUNTRY_CODES }}" \
            --from-literal=DWOLLA_KEY="${{ secrets. DWOLLA_KEY }}" \
            --from-literal=DWOLLA_SECRET="${{ secrets. DWOLLA_SECRET }}" \
            --from-literal=DWOLLA_BASE_URL="${{ secrets.DWOLLA_BASE_URL }}" \
            --from-literal=DWOLLA_ENV="${{ secrets.DWOLLA_ENV }}"

      - name: Apply Kubernetes configurations
        run: kubectl apply -f kubernetes/

      - name: Rollout status
        run: kubectl rollout status deployment/${{ env.DEPLOYMENT_NAME }} --timeout=5m

      - name: Verify deployment
        run: |
          echo "=== Deployment Status ==="
          kubectl get deployment ${{ env.DEPLOYMENT_NAME }}
          echo ""
          echo "=== Pods ==="
          kubectl get pods -l app=${{ env. DEPLOYMENT_NAME }}
          echo ""
          echo "=== Services ==="
          kubectl get svc ${{ env.DEPLOYMENT_NAME }}
          echo ""
          echo "=== Ingress ==="
          kubectl get ingress ${{ env.DEPLOYMENT_NAME }}

      - name: Slack Notification
        if: always()
        uses: act10ns/slack@v1
        with: 
          status: ${{ job. status }}
          steps: ${{ toJson(steps) }}
          channel: '#all-apps'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
