name: Build

on:
  push:
    branches:
      - main
env:
  IMAGE_NAME: xjohnfit/upscale-banking
  
jobs:
  CI:
    name: Build
    runs-on: [self-hosted]
    steps:
      
      - name: Checkout Repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      
      - name: Sonarqube Analisys
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      
      - name: Trivy File Scan
        run: trivy fs . > trivyfs.txt
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          tags: ${{ steps.meta.outputs.tags }}
          annotations: ${{ steps.meta.outputs.annotations }}
          push: true

      - name: Trivy Image Scan
        run: trivy image ${{ env.IMAGE_NAME }} > trivyimage.txt

      - name: Slack Notification
        if: always()
        uses: act10ns/slack@v1
        with:
          status: ${{ job.status }}
          steps: ${{ toJson(steps) }}
          channel: '#all-apps'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}  
  CD:
    needs: CI
    runs-on: [self-hosted]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
      - name: Set up kubeconfig for k3s
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_K3S" > $HOME/.kube/config
        env:
          KUBECONFIG_K3S: ${{ secrets.KUBECONFIG_K3S }}
      - name: Create Docker registry secret
        run: |
          kubectl delete secret regcred --ignore-not-found
          kubectl create secret docker-registry regcred \
            --docker-server=https://index.docker.io/v1/ \
            --docker-username=${{ secrets. DOCKERHUB_USERNAME }} \
            --docker-password=${{ secrets.DOCKERHUB_TOKEN }}

      - name: kubectl apply
        run: kubectl apply -f kubernetes/

      - name: Rollout status
        run: kubectl rollout status deployment/nextjs15-upscale-banking

      - name: Slack Notification
        if: always()
        uses: act10ns/slack@v1
        with:
          status: ${{ job.status }}
          steps: ${{ toJson(steps) }}
          channel: '#all-apps'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
     
